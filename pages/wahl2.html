<script>
  // --- Payload lesen (neu: ?p=..., fallback: alte Parameter) ---
  function readPayload() {
    const params = new URLSearchParams(window.location.search);

    // 1) Neu: komprimierter Payload
    const p = params.get("p");
    if (p) {
      try {
        const json = LZString.decompressFromEncodedURIComponent(p);
        if (!json) throw new Error("Payload konnte nicht entpackt werden (leer).");
        const data = JSON.parse(json);

        // kurze Keys (wie in qr.js vorgeschlagen)
        return {
          wahl: data.w || "",
          bkz: data.b || "",
          betrieb: data.n || "",
          vorsitz: data.v || "",
          anschrift: data.a || "",
          email: data.e || "wahlvorstand@firma.de"
        };
      } catch (e) {
        console.error("Payload decode error:", e);
        // fallback auf alte Parameter
      }
    }

    // 2) Fallback: alte Parameter (dein bisheriger Weg)
    return {
      wahl: params.get("wahl") || "",
      bkz: params.get("bkz") || "",
      betrieb: params.get("betrieb") || "[Wahlbetrieb eintragen]",
      vorsitz: params.get("vorsitz") || "[Vorsitzenden eintragen]",
      anschrift: params.get("anschrift") || "[Anschrift nicht angegeben]",
      email: params.get("email") || "wahlvorstand@firma.de"
    };
  }

  const payload = readPayload();

  // Wahl optional in localStorage sichern (damit deine anderen Seiten es auch haben)
  if (payload.wahl) {
    localStorage.setItem("wahlId", payload.wahl);
  }

  // Infos anzeigen
  document.getElementById("info").innerHTML = `
    ${payload.wahl ? `<p><b>Wahl:</b> ${payload.wahl}</p>` : ""}
    ${payload.bkz ? `<p><b>BKZ:</b> ${payload.bkz}</p>` : ""}
    <p><b>Wahlbetrieb:</b> ${payload.betrieb || "[Wahlbetrieb eintragen]"}</p>
    <p><b>Vorsitzender des Wahlvorstands:</b> ${payload.vorsitz || "[Vorsitzenden eintragen]"}</p>
    <p><b>Anschrift des Wahlvorstands:</b> ${payload.anschrift || "[Anschrift nicht angegeben]"}</p>
    <p><b>E-Mail-Adresse Wahlvorstand:</b> ${payload.email || "wahlvorstand@firma.de"}</p>
  `;

  function buildMailText(vorname, nachname, pnr, grund) {
    let grundText = grund ? `wegen ${grund}` : "wegen Abwesenheit vom Betrieb";
    return `Sehr geehrte Damen und Herren,
hiermit beantrage ich ${vorname} ${nachname} gemäß § 24 Absatz 1 Wahlordnung BetrVG
die schriftliche Stimmabgabe. Da ich zum Zeitpunkt der Wahl ${grundText} verhindert bin, 
meine Stimme abzugeben.

Mit freundlichen Grüßen,
${vorname} ${nachname}
Personalnummer: ${pnr}`;
  }

  function sendMail() {
    let vorname = document.getElementById("vorname").value.trim();
    let nachname = document.getElementById("nachname").value.trim();
    let pnr = document.getElementById("pnr").value.trim();
    let grund = document.getElementById("grund").value.trim();

    if (!vorname || !nachname || !pnr) {
      alert("Bitte alle Pflichtfelder ausfüllen!");
      return;
    }

    const subject = `Briefwahlanforderung zur BR-Wahl - ${payload.betrieb || ""}`;
    const mailtext = buildMailText(vorname, nachname, pnr, grund);

    window.location.href =
      `mailto:${payload.email || "wahlvorstand@firma.de"}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(mailtext)}`;
  }

  async function downloadPDF() {
    let vorname = document.getElementById("vorname").value.trim();
    let nachname = document.getElementById("nachname").value.trim();
    let pnr = document.getElementById("pnr").value.trim();
    let grund = document.getElementById("grund").value.trim();
    let absender = document.getElementById("absender").value.trim();
    let Wohnort = document.getElementById("Wohnort").value.trim();

    if (!vorname || !nachname || !pnr) {
      alert("Bitte alle Pflichtfelder ausfüllen!");
      return;
    }

    const mailtext = buildMailText(vorname, nachname, pnr, grund);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.setFontSize(12);

    // Absenderanschrift oben links
    if (absender) {
      pdf.text(`${vorname} ${nachname}`, 20, 20);
      pdf.text(absender, 20, 26);
      pdf.text(Wohnort, 20, 32);
      pdf.text(`Personalnummer: ${pnr}`, 20, 38);
    }

    // Empfängeradresse (Wahlvorstand)
    pdf.text("An den Wahlvorstand", 20, 50);
    pdf.text(payload.vorsitz || "", 20, 56);
    pdf.text(payload.anschrift || "", 20, 62);

    // Text
    let splitText = pdf.splitTextToSize(mailtext, 170);
    pdf.text(splitText, 20, 90);

    // Fuß mit Daten
    pdf.text(`Wahlbetrieb: ${payload.betrieb || ""}`, 20, 250);
    pdf.text(`Vorsitzender: ${payload.vorsitz || ""}`, 20, 256);
    pdf.text(`Anschrift Wahlvorstand: ${payload.anschrift || ""}`, 20, 262);

    pdf.save("briefwahlanforderung.pdf");
  }

  // damit deine Buttons weiter funktionieren (onclick nutzt diese Namen)
  window.sendMail = sendMail;
  window.downloadPDF = downloadPDF;
</script>